 var serviceType= $('#calculator1-callback-service-type option:selected'), systemType= $('#calculator1-callback-system-type option:selected'), feedback = $('#calculator1-callback-service-content'), fullName = $('#calculator1-callback-name'), email = $('#calculator1-callback-email'), phoneNum = $('#calculator1-callback-phone'), schemeUrl = $('#calculator1-callback-link'), schemeFile = $('#calculator1-callback-file'); function update_calc() { $.ajax({ url: '/api/get_objects_avalible_filters/', method: 'GET', data: $('#calculator_form').serialize(), dataType: 'json', processData: false, contentType: false, success: function (data) { var af = data.available_filters; $('.calculator-type-choice input').each(function(i){ if( af.indexOf($(this).val()) == -1){ $(this).attr('disabled', 'disabled'); $(this).removeAttr('checked'); } else { $(this).removeAttr('disabled'); } }) } }); } $(document) .ready(update_calc) .on('change', '.calculator-choice input', update_calc) .on('click', '#calculator1-callback-button', function (e) { e.preventDefault(); $('#calculator1-callback-button').attr('disabled', 'disabled'); var delFile = $("input[name^='jfiler-items-exclude-']:hidden").val(); if(delFile){ delFile = JSON.parse(delFile); }else{ delFile = [] } if (phoneNum.val() && fullName.val()){ phoneNum.css('border-color', '#7b7b7b'); fullName.css('border-color', '#7b7b7b'); var content = 'Услуга: ' + serviceType.text() + '; <br/>\ ' + 'Система: ' + systemType.text() +';<br/>\ ' + 'Комментарий: ' + feedback.val() + '<br/>'; var fd = new FormData(); var fileCount = 0; fd.append('comment', content); fd.append('message_type', 'calculation'); fd.append('name', fullName.val()); fd.append('email', email.val()); fd.append('phone', phoneNum.val()); fd.append('feedback_url', schemeUrl.val()); fd.append('url', "/"); fd.append('csrfmiddlewaretoken', 'OL8omJFw7h3WpVUb8Gv3YdnUthw8nVUK'); $.each(schemeFile, function(i, obj) { $.each(obj.files,function(j, file){ if(delFile.indexOf(file.name) == -1){ fd.append('file-'+fileCount+'-file', file); fileCount++; } }) }); console.log(fileCount); fd.append('file-TOTAL_FORMS', fileCount); fd.append('file-INITIAL_FORMS', '0'); fd.append('file-MAX_NUM_FORMS', ''); $.ajax({ url: '/quick_message/', method: 'POST', data: fd, processData: false, contentType: false, success: function () { feedback.val(''); fullName.val(''); email.val(''); phoneNum.val(''); schemeUrl.val(''); var filerKit = $("#calculator1-callback-file").prop("jFiler"); filerKit.reset(); $('#calculator1-callback-Modal').modal('hide'); $('#success_message_call_back').modal('show'); $('#calculator1-callback-button').removeAttr('disabled'); fbq('track', 'Lead'); }, error: function () { $('#calculator1-callback-button').removeAttr('disabled'); } }); } else { if (!fullName.val()){ console.log('error'); var input_label = $("label[for='"+fullName.attr('id')+"']"); input_label.css('color', 'red'); fullName.css('border-color', 'red'); } if (!phoneNum.val()){ console.log('error'); var input_label = $("label[for='"+phoneNum.attr('id')+"']"); input_label.css('color', 'red'); phoneNum.css('border-color', 'red'); } } return false; }); fullName.on('input', function () { var input_label = $("label[for='"+fullName.attr('id')+"']"); input_label.css('color', 'inherit'); fullName.css('border-color', '#6d6d6d'); }); phoneNum.on('input', function () { var input_label = $("label[for='"+phoneNum.attr('id')+"']"); input_label.css('color', 'inherit'); phoneNum.css('border-color', '#6d6d6d'); }); $("#calc-max-collapse").on("shown.bs.collapse", function () { $("select").select2("destroy"); $("select").select2(); $('b[role="presentation"]').hide(); $('.select2-selection__arrow').append('<i class="presentation"></i>'); var scrollTo = $('#calc-max-collapse'); $(document).scrollTop( scrollTo.offset().top - 100 ); }); 