(function(a){a(document).ready(function(){a(".ptb_relation_multiply").each(function(){var c=a(this),d=a(this).closest(".ptb_relation_autocomplete_wrap").find('input[type="hidden"]');a(this).children("ul").sortable({items:"li",connectWith:c,placeholder:"ptb_relation_ui_state_highlight",cursor:"move",revert:100,sort:function(e,f){a(".ptb_relation_ui_state_highlight").height(f.item.outerHeight(true)).width(f.item.outerWidth(true))},stop:function(f,g){var e=[];c.find("li").each(function(){e.push(a(this).data("id"))});d.val(e.join(", "))}})});a(".ptb_relation_autocomplete").each(function(){var f=a(this),e=a(this).closest(".ptb_relation_autocomplete_wrap"),g=e.find('input[type="hidden"]'),c=a(this).data("multiply"),d=a(this).data("ajax");a(this).autocomplete({minLength:2,source:function(j,h){var i=a.trim(j.term);a.getJSON(d,{term:i},function(l,k,m){h(l)})},select:function(i,j){if(c){var h=g.val().split(", ");if(a.inArray(j.item.id.toString(),h)===-1){h.push(j.item.id);g.val(h.join(", "));f.val("");e.find("ul").append('<li><span class="ptb_relation_term">'+j.item.value+'</span><span data-id="'+j.item.id+'" class="ti-close ptb_relation_remove_term"></span></li>')}}else{g.val(j.item.id);this.value=j.item.value}return false}}).focus(function(){a(this).autocomplete("search")})});a(".ptb_relation_many").delegate(".ptb_relation_remove_term","click",function(g){g.preventDefault();if(confirm(ptb_relation.confirm)){var f=a(this).closest(".ptb_relation_autocomplete_wrap"),h=f.find('input[type="hidden"]'),d=a.trim(h.val()).split(", "),c=d.indexOf(a(this).data("id").toString());a(this).closest("li").remove();if(c!==-1){d.splice(c,1);h.val(d.join(", "))}}});function b(c){return c.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}a.expr[":"].contains=a.expr.createPseudo(function(c){return function(d){return a(d).text().toUpperCase().indexOf(c.toUpperCase())>=0}});a("body").delegate(".ptb_relation_searh_posts","keyup",function(){var c=a.trim(a(this).val()),d=a(this).closest("form").find(".ptb_relation_posts_wrap label");if(c){d.hide();d.filter(":contains("+b(c).toUpperCase()+")").show()}else{d.show()}});a("body").delegate(".ptb_relation_uncheck","click",function(c){c.preventDefault();a(this).closest("form").find(".ptb_relation_posts_wrap input").removeAttr("checked")});a("body").delegate("#ptb_relation_select_posts","submit",function(h){h.preventDefault();var m=a(this).serializeArray(),f=a(".ptb_current_ajax").closest(".ptb_relation_autocomplete_wrap"),i=f.find('input[type="hidden"]'),d=f.find("input.ptb_relation_autocomplete"),j=d.data("multiply"),g=i.val().split(", "),c="";for(var l in m){var k=m[l],n=k.value.toString();if(a.inArray(n,g)===-1){g.push(n);if(j){c+='<li><span class="ptb_relation_term">'+a("#ptb-related-post-"+n).closest("label").text()+'</span><span data-id="'+n+'" class="ti-close ptb_relation_remove_term"></span></li>'}}}if(c||!j){if(j){f.find("ul").append(c)}else{d.val(a.trim(a("#ptb-related-post-"+n).closest("label").text()))}i.val(g.join(", "))}a(".ptb_close_lightbox").trigger("click")})})}(jQuery));